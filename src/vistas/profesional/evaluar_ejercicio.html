{% extends "base.html" %}

{% block title %}Evaluar Ejercicio - TerapiTrack{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-star-fill me-2"></i>Evaluar Ejercicio</h2>
    <a href="{{ url_for('profesional.evaluar_sesion', sesion_id=ejercicio_sesion.Sesion_Id) }}" 
       class="btn btn-secondary">
        <i class="bi bi-arrow-left me-1"></i>Volver a la sesión
    </a>
</div>

<div class="card shadow mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">{{ ejercicio_sesion.ejercicio.Nombre }}</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Video demostrativo -->
            <div class="col-md-6 mb-4">
                <h5>Video demostrativo:</h5>
                <video controls class="w-100 rounded" style="max-height: 300px;">
                    {% if ejercicio_sesion.ejercicio.Video.startswith('http') %}
                        <!-- Vídeo en URL (Cloudinary u otro) -->
                        <source src="{{ ejercicio_sesion.ejercicio.Video }}" type="video/mp4">
                    {% elif ejercicio_sesion.ejercicio.Video.startswith('ejercicio_') %}
                        <!-- Vídeo subido por profesional -->
                        <source src="{{ url_for('static', filename='uploads/ejercicios/' + ejercicio_sesion.ejercicio.Video) }}" type="video/mp4">
                    {% else %}
                        <!-- Vídeo base del sistema -->
                        <source src="{{ url_for('static', filename='videos/' + ejercicio_sesion.ejercicio.Video) }}" type="video/mp4">
                    {% endif %}
                    Tu navegador no soporta videos.
                </video>
                <p class="mt-2 small text-muted">{{ ejercicio_sesion.ejercicio.Descripcion }}</p>
            </div>

            <!-- Video del paciente -->
            <div class="col-md-6 mb-4">
                <h5>Video del paciente:</h5>
                {% if video_respuesta %}
                <video controls class="w-100 rounded" style="max-height: 300px;">
                    <source src="{{ video_respuesta.Ruta_Almacenamiento }}" type="video/webm">
                    Tu navegador no soporta videos.
                </video>
                <p class="mt-2 small text-muted">
                    Grabado el: {{ video_respuesta.Fecha_Expiracion.strftime('%d/%m/%Y') if video_respuesta.Fecha_Expiracion else 'Fecha no disponible' }}
                </p>
                {% else %}
                <div class="alert alert-warning d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <div>
                        <strong>No hay video disponible</strong>
                        <p class="mb-0">Este ejercicio no fue grabado durante la sesión.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
       
        <!-- Formulario de evaluación solo si hay video -->
        {% if video_respuesta %}
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <form method="POST">
                    {{ form.hidden_tag() }}
                   
                    <div class="mb-4">
                        <h5 class="fw-bold mb-3">
                            <i class="bi bi-star-fill text-warning me-2"></i>Evaluación del ejercicio
                        </h5>
                       
                        <!-- ✅ PUNTUACIÓN BONITA con estrellas -->
                        <div class="mb-4">
                            <label class="form-label fw-bold mb-3">Puntuación del ejercicio:</label>
                            <div class="rating-container">
                                {% for i in range(1, 6) %}
                                <div class="rating-item">
                                    <input type="radio" id="rating-{{ i }}" name="puntuacion" value="{{ i }}"
                                           {% if form.puntuacion.data == i %}checked{% endif %}
                                           class="rating-input">
                                    <label for="rating-{{ i }}" class="rating-label">
                                        <div class="rating-star">
                                            <i class="bi bi-star-fill"></i>
                                        </div>
                                        <div class="rating-text">{{ i }}</div>
                                        <div class="rating-description">
                                            {% if i == 1 %}Muy deficiente
                                            {% elif i == 2 %}Deficiente
                                            {% elif i == 3 %}Regular
                                            {% elif i == 4 %}Bueno
                                            {% elif i == 5 %}Excelente
                                            {% endif %}
                                        </div>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            {% if form.puntuacion.errors %}
                            <div class="text-danger mt-2">
                                {% for error in form.puntuacion.errors %}
                                <small><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                       
                        <!-- Comentarios -->
                        <div class="mb-3">
                            {{ form.comentarios.label(class="form-label fw-bold") }}
                            {{ form.comentarios(class="form-control", rows=4, placeholder="Añade comentarios sobre la ejecución del ejercicio...") }}
                            {% if form.comentarios.errors %}
                            <div class="text-danger">
                                {% for error in form.comentarios.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                   
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle me-1"></i>Guardar Evaluación
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info text-center">
            <h5><i class="bi bi-info-circle me-2"></i>No se puede evaluar</h5>
            <p class="mb-0">No hay video grabado para este ejercicio, por lo que no se puede realizar una evaluación.</p>
            <a href="{{ url_for('profesional.evaluar_sesion', sesion_id=ejercicio_sesion.Sesion_Id) }}"
               class="btn btn-primary mt-3">
                <i class="bi bi-arrow-left me-1"></i>Volver a la sesión
            </a>
        </div>
        {% endif %}
    </div>
</div>


<!-- ✅ ESTILOS CSS PARA PUNTUACIÓN BONITA -->
<style>
.rating-container {
    display: flex;
    gap: 15px;
    justify-content: center;
    flex-wrap: wrap;
}


.rating-item {
    position: relative;
}


.rating-input {
    display: none;
}


.rating-label {
    cursor: pointer;
    text-align: center;
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    background: white;
    transition: all 0.3s ease;
    display: block;
    min-width: 80px;
}


.rating-label:hover {
    border-color: #ffc107;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}


.rating-input:checked + .rating-label {
    border-color: #ffc107;
    background: #fff3cd;
    transform: scale(1.05);
}


.rating-star {
    font-size: 1.5rem;
    color: #6c757d;
    margin-bottom: 5px;
}


.rating-input:checked + .rating-label .rating-star {
    color: #ffc107;
}


.rating-input:hover + .rating-label .rating-star {
    color: #ffc107;
}


.rating-text {
    font-weight: bold;
    font-size: 1.1rem;
    margin-bottom: 3px;
}


.rating-description {
    font-size: 0.8rem;
    color: #6c757d;
}


.rating-input:checked + .rating-label .rating-description {
    color: #856404;
    font-weight: 500;
}
</style>
{% endblock %}