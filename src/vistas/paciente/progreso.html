{% extends "base.html" %}

{% block title %}Mi Progreso - TerapiTrack{% endblock %}

{% block content %}
<div class="container-fluid vh-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem 0;">
    
    <!-- Botón de regreso (mapeado al botón Y del mando) -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{{ url_for('paciente.dashboard') }}" class="btn btn-outline-light btn-lg snes-back-btn" id="btn-back">
            <span class="snes-letter">Y</span>
            <i class="bi bi-arrow-left me-2"></i>Volver al Inicio
        </a>
    </div>

    <!-- Cabecera principal de la sección de progreso -->
    <div class="text-center mb-4">
        <h1 class="display-5 fw-bold text-white mb-3">
            <i class="bi bi-graph-up me-2"></i>Mi Progreso
        </h1>
        <p class="text-white-50">Seguimiento de tu evolución terapéutica</p>
    </div>

    <!-- Bloque superior: estadísticas + gráfico de evolución -->
    {% if stats.total_evaluaciones > 0 %}
    <div class="row justify-content-center mb-4">
        <div class="col-md-10">
            <div class="row g-4">
                <!-- Tarjeta de estadísticas principales -->
                <div class="col-md-6">
                    <div class="card bg-white bg-opacity-95 h-100">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Tus Números</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-6">
                                    <div class="stat-card bg-primary text-white text-center p-3 rounded">
                                        <h3 class="mb-0">{{ stats.total_evaluaciones }}</h3>
                                        <small>Evaluaciones</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-card bg-success text-white text-center p-3 rounded">
                                        <h3 class="mb-0">{{ stats.puntuacion_promedio }}</h3>
                                        <small>Promedio</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-card bg-warning text-white text-center p-3 rounded">
                                        <h3 class="mb-0">{{ stats.mejor_puntuacion }}</h3>
                                        <small>Mejor nota</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-card bg-info text-white text-center p-3 rounded">
                                        <h3 class="mb-0">{{ stats.ultima_evaluacion|datetimeformat('%d/%m') if stats.ultima_evaluacion else '--' }}</h3>
                                        <small>Última eval.</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Mensaje motivacional según promedio -->
                            <div class="mt-4 text-center">
                                {% if stats.puntuacion_promedio >= 4 %}
                                    <div class="alert alert-success">
                                        <i class="bi bi-trophy-fill me-2"></i>Excelente trabajo, tu evolución es muy positiva.
                                    </div>
                                {% elif stats.puntuacion_promedio >= 3 %}
                                    <div class="alert alert-info">
                                        <i class="bi bi-hand-thumbs-up-fill me-2"></i>Vas por buen camino, mantén la constancia.
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning">
                                        <i class="bi bi-heart-fill me-2"></i>Cada sesión suma, sigue practicando con calma.
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tarjeta con gráfico de evolución -->
                <div class="col-md-6">
                    <div class="card bg-white bg-opacity-95 h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Tu Evolución</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="progressChart" width="300" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Listado de ejercicios evaluados, navegable con mando -->
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card bg-white bg-opacity-95">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Mis Ejercicios Evaluados</h5>
                    <small class="text-light">Usa ← → para navegar entre tarjetas</small>
                </div>
                <div class="card-body">
                    {% if evaluaciones %}
                        <div id="evaluacionesContainer" class="position-relative">
                            <div class="row g-3" id="evaluacionesGrid">
                                {% for evaluacion in evaluaciones %}
                                <div class="col-md-6 evaluacion-card" data-index="{{ loop.index0 }}">
                                    <div class="card border-left-primary h-100">
                                        <div class="card-body p-3">
                                            <!-- Nombre del ejercicio y fecha de evaluación -->
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="card-title text-primary mb-1">{{ evaluacion.ejercicio_sesion.ejercicio.Nombre }}</h6>
                                                <small class="text-muted">{{ evaluacion.Fecha_Evaluacion|datetimeformat('%d/%m/%Y') }}</small>
                                            </div>
                                            
                                            <!-- Puntuación con estrellas destacadas -->
                                            <div class="text-center mb-2">
                                                <div class="score-display-large">
                                                    {% for i in range(1, 6) %}
                                                        <i class="bi bi-star{% if i <= evaluacion.Puntuacion %}-fill text-warning{% else %} text-muted{% endif %} fs-4"></i>
                                                    {% endfor %}
                                                </div>
                                                <div class="mt-1">
                                                    <span class="badge bg-primary fs-6">{{ evaluacion.Puntuacion }}/5</span>
                                                </div>
                                            </div>
                                            
                                            <!-- Tipo de ejercicio -->
                                            <div class="text-center mb-2">
                                                <span class="badge bg-info">{{ evaluacion.ejercicio_sesion.ejercicio.Tipo }}</span>
                                            </div>
                                            
                                            <!-- Comentario del profesional -->
                                            {% if evaluacion.Comentarios %}
                                            <div class="alert alert-light mb-0">
                                                <small><strong>Comentario de tu terapeuta:</strong></small>
                                                <p class="mb-0 mt-1"><em>"{{ evaluacion.Comentarios }}"</em></p>
                                            </div>
                                            {% else %}
                                            <div class="text-center text-muted">
                                                <small><em>Sin comentarios adicionales</em></small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-graph-up fs-1 text-muted mb-3"></i>
                            <h5 class="text-muted">No tienes evaluaciones aún</h5>
                            <p class="text-muted">Cuando completes sesiones y sean evaluadas aparecerán aquí.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Información fija sobre navegación con el mando -->
    <div class="navigation-help">
        <strong>Navegación con mando:</strong><br>
        ← → : Navegar entre evaluaciones<br>
        ↑ ↓ : Bajar/Subir en la pantalla<br>
        Y : Volver
    </div>
</div>

{% endblock %} 

{% block style %}

<style>
/* Botón verde tipo botón Y del mando */
.snes-back-btn {
    position: relative;
    border: 3px solid rgba(255,255,255,0.8);
    background: linear-gradient(145deg, #228B22, #006400);
}

.snes-back-btn:hover {
    background: linear-gradient(145deg, #32CD32, #228B22);
    border-color: white;
    color: white;
}

/* Circulito con letra Y en el botón de volver */
.snes-letter {
    position: absolute;
    top: -5px;
    right: 8px;
    font-size: 0.8rem;
    font-weight: bold;
    background: rgba(255,255,255,0.9);
    color: #006400;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Tarjetas de estadísticas */
.stat-card {
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: scale(1.05);
}

/* Borde lateral azul para tarjetas de evaluación */
.border-left-primary {
    border-left: 4px solid #007bff !important;
}

/* Tarjeta de evaluación cuando se navega con mando */
.evaluacion-card {
    transition: all 0.3s ease;
}

.evaluacion-card.mando-selected {
    transform: scale(1.02);
    z-index: 10;
}

.evaluacion-card.mando-selected .card {
    border: 3px solid #ffc107;
    box-shadow: 0 0 20px rgba(255,193,7,0.5);
}

/* Efecto hover general sobre tarjetas */
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

/* Estrellas con mayor separación para legibilidad */
.score-display-large {
    letter-spacing: 2px;
}

/* Caja fija con ayuda de navegación */
.navigation-help {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0,0,0,0.85);
    color: white;
    padding: 25px;
    border-radius: 12px;
    font-size: 1.1rem;
    z-index: 1000;
    box-shadow: 0 6px 20px rgba(0,0,0,0.6);
    min-width: 220px;
}

/* Ajustes responsivos para móviles */
@media (max-width: 768px) {
    .col-md-6 {
        margin-bottom: 1rem;
    }
    
    .fs-4 {
        font-size: 1.2rem !important;
    }
}
</style>

{% endblock %}

{% block scripts %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const backBtn = document.getElementById('btn-back');
    
    let selectedCardIndex = 0;
    let gamepadIndex = null;
    let lastButtonStates = { Y: false, left: false, right: false, up: false, down: false };
    
    // Crear gráfico de progreso si existen evaluaciones
    {% if stats.total_evaluaciones > 0 %}
    const ctx = document.getElementById('progressChart').getContext('2d');
    const evalSesion = {{ evaluaciones_sesion_json|tojson }};

    const ultimasSesiones = evalSesion;

    const fechas = ultimasSesiones.map(e =>
        e.Fecha
            ? new Date(e.Fecha).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' })
            : ''
    );
    const puntuaciones = ultimasSesiones.map(e => e.Media_Puntuacion);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: fechas,
            datasets: [{
                label: 'Puntuación',
                data: puntuaciones,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.4,
                fill: true,
                pointRadius: 8,
                pointHoverRadius: 10,
                pointBackgroundColor: 'rgb(75, 192, 192)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 5,
                    ticks: {
                        stepSize: 1,
                        font: {
                            size: 16
                        }
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 14
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    {% endif %}
    
    // Resalta visualmente una tarjeta de evaluación según índice
    function highlightCard(index) {
        document.querySelectorAll('.evaluacion-card').forEach(card => {
            card.classList.remove('mando-selected');
        });
        
        const cards = document.querySelectorAll('.evaluacion-card');
        if (index >= 0 && index < cards.length) {
            cards[index].classList.add('mando-selected');
            cards[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // Eventos de conexión del mando
    window.addEventListener('gamepadconnected', (e) => {
        gamepadIndex = e.gamepad.index;
        console.log('Mando conectado (progreso):', e.gamepad.id);
        requestAnimationFrame(pollGamepad);
    });

    window.addEventListener('gamepaddisconnected', () => {
        console.log('Mando desconectado (progreso)');
        gamepadIndex = null;
    });

    // Lectura continua del mando para navegación en esta pantalla
    function pollGamepad() {
        if (gamepadIndex === null) return;

        const pads = navigator.getGamepads();
        const gp = pads[gamepadIndex];
        if (!gp) {
            requestAnimationFrame(pollGamepad);
            return;
        }

        // Mapping adaptado: 0=X, 1=A, 2=B, 3=Y
        const btnY = gp.buttons[3]?.pressed || false;

        const axisX = gp.axes[0] || 0;
        const axisY = gp.axes[1] || 0;

        const left  = axisX < -0.5;
        const right = axisX >  0.5;
        const up    = axisY < -0.5;
        const down  = axisY >  0.5;

        const states = { Y: btnY, left, right, up, down };

        // Y: volver al dashboard del paciente
        if (states.Y && !lastButtonStates.Y) {
            backBtn.click();
        }
        
        // Navegación lateral entre tarjetas de evaluación
        const cards = document.querySelectorAll('.evaluacion-card');

        if (states.left && !lastButtonStates.left) {
            if (selectedCardIndex > 0) {
                selectedCardIndex--;
                highlightCard(selectedCardIndex);
            }
        }

        if (states.right && !lastButtonStates.right) {
            if (selectedCardIndex < cards.length - 1) {
                selectedCardIndex++;
                highlightCard(selectedCardIndex);
            }
        }
        
        // Desplazamiento vertical de la página
        if (states.up && !lastButtonStates.up) {
            window.scrollBy(0, -200);
        }
        
        if (states.down && !lastButtonStates.down) {
            window.scrollBy(0, 200);
        }
        
        lastButtonStates = states;
        requestAnimationFrame(pollGamepad);
    }
    
    // Selección inicial de la primera tarjeta, si existe
    if (document.querySelectorAll('.evaluacion-card').length > 0) {
        highlightCard(selectedCardIndex);
    }
});
</script>

{% endblock %}
