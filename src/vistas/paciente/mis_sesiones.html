{% extends "base.html" %}

{% block title %}Mis Sesiones - TerapiTrack{% endblock %}

{% block content %}
<div class="container-fluid vh-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem 0;">
    
    <!-- Botón de regreso (mapeado al botón Y del mando) -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{{ url_for('paciente.dashboard') }}" class="btn btn-outline-light btn-lg snes-back-btn" id="btn-back">
            <span class="snes-letter">Y</span>
            <i class="bi bi-arrow-left me-2"></i>Volver al Inicio
        </a>
        
        <!-- Indicador de estado del mando -->
        <div class="text-white">
            <i class="bi bi-controller me-1"></i>
            <span class="badge bg-secondary" id="mando-status">Buscando mando...</span>
        </div>
    </div>

    <!-- Cabecera principal -->
    <div class="text-center mb-4">
        <h1 class="display-5 fw-bold text-white mb-3">
            <i class="bi bi-calendar-check me-2"></i>Mis Sesiones
        </h1>
        
        <!-- Tarjeta con rango de fechas del periodo mostrado -->
        <div class="row justify-content-center mb-3">
            <div class="col-md-6">
                <div class="card bg-white bg-opacity-90">
                    <div class="card-body py-2">
                        <h5 class="mb-0" id="currentPeriod">Próximas 3 Semanas</h5>
                        <small class="text-muted" id="dateRange">Cargando...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendario de sesiones para 3 semanas -->
    <div class="row justify-content-center">
        <div class="col-md-11">
            <div class="card bg-white bg-opacity-95">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-calendar3 me-2"></i>Calendario de Sesiones</h5>
                </div>
                <div class="card-body p-0">
                    <!-- Cabecera con días de la semana -->
                    <div class="row g-0 border-bottom bg-light">
                        <div class="col text-center py-2 fw-bold">Lunes</div>
                        <div class="col text-center py-2 fw-bold">Martes</div>
                        <div class="col text-center py-2 fw-bold">Miércoles</div>
                        <div class="col text-center py-2 fw-bold">Jueves</div>
                        <div class="col text-center py-2 fw-bold">Viernes</div>
                        <div class="col text-center py-2 fw-bold">Sábado</div>
                        <div class="col text-center py-2 fw-bold">Domingo</div>
                    </div>

                    <!-- Contenedor donde se inyectan las semanas del calendario -->
                    <div id="calendarWeeks">
                        <!-- Se llena dinámicamente con JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Panel inferior con información de la sesión seleccionada -->
            <div class="card mt-3 bg-white bg-opacity-95" id="selectedSessionCard" style="display: none;">
                <div class="card-header text-white" style="background: #dc3545 !important;">
                    <h5 class="mb-0"><i class="bi bi-play-circle me-2"></i>Sesión Lista para Iniciar</h5>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div id="selectedSessionInfo">
                                <!-- Información detallada de la sesión seleccionada -->
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-lg text-white" id="startSessionBtn" style="display: none; background: #dc3545 !important; border-color: #dc3545;">
                                <span class="snes-letter-action">A</span>
                                <i class="bi bi-play-circle me-1"></i>Iniciar Sesión
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leyenda fija con controles del mando para esta pantalla -->
    <div class="navigation-help">
        <strong>Navegación con mando:</strong><br>
        ← → : Mover entre sesiones<br>
        ↑ ↓ : Bajar/Subir en la pantalla<br>
        A : Iniciar sesión<br>
        Y : Volver
    </div>
</div>

{% endblock %} 

{% block style %}

<style>
/* Botón de volver tipo botón Y del mando */
.snes-back-btn {
    position: relative;
    border: 3px solid rgba(255,255,255,0.8);
    background: linear-gradient(145deg, #228B22, #006400);
}

.snes-back-btn:hover {
    background: linear-gradient(145deg, #32CD32, #228B22);
    border-color: white;
    color: white;
}

/* Circulito con letra Y en el botón de volver */
.snes-letter {
    position: absolute;
    top: -5px;
    right: 8px;
    font-size: 0.8rem;
    font-weight: bold;
    background: rgba(255,255,255,0.9);
    color: #006400;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Circulito con letra A en el botón de iniciar sesión */
.snes-letter-action {
    position: absolute;
    top: -5px;
    right: 8px;
    font-size: 0.8rem;
    font-weight: bold;
    background: rgba(255,255,255,0.9);
    color: #dc3545;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Celda de día del calendario */
.calendar-day {
    min-height: 120px;
    border: 1px solid #dee2e6;
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 8px;
}

.calendar-day:hover {
    background-color: rgba(0,123,255,0.1);
}

/* Número de día en la esquina superior */
.day-number {
    position: absolute;
    top: 5px;
    left: 8px;
    font-weight: bold;
    color: #6c757d;
    font-size: 1rem;
}

/* Contenedor de sesiones de un día */
.day-sessions {
    margin-top: 25px;
    padding: 5px;
}

/* Tarjeta individual de sesión dentro del día */
.session-item {
    background: linear-gradient(145deg, #007bff, #0056b3);
    color: white;
    padding: 6px 8px;
    margin-bottom: 4px;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
}

.session-item:hover {
    transform: scale(1.02);
    border-color: rgba(255,255,255,0.8);
}

/* Sesión seleccionada visualmente en rojo (coincide con panel inferior) */
.session-item.selected {
    background: #dc3545 !important;
    border-color: white !important;
    animation: pulseRed 2s infinite;
}

@keyframes pulseRed {
    0%, 100% { 
        box-shadow: 0 0 15px rgba(220,53,69,0.7); 
        background: #dc3545 !important;
    }
    50% { 
        box-shadow: 0 0 25px rgba(220,53,69,0.9); 
        background: #c82333 !important;
    }
}

/* Resaltado específico cuando se navega con el mando */
.session-item.mando-highlighted {
    border-color: #ffc107 !important;
    border-width: 3px !important;
    animation: pulseHighlight 1s infinite;
}

@keyframes pulseHighlight {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}
</style>

{% endblock %}

{% block scripts %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const backBtn = document.getElementById('btn-back');
    const calendarWeeks = document.getElementById('calendarWeeks');
    const selectedSessionCard = document.getElementById('selectedSessionCard');
    const selectedSessionInfo = document.getElementById('selectedSessionInfo');
    const startSessionBtn = document.getElementById('startSessionBtn');
    const mandoStatus = document.getElementById('mando-status');
    const dateRange = document.getElementById('dateRange');
    
    let selectedSession = null;
    let selectedSessionIndex = -1;
    let availableSessions = [];
    let gamepadIndex = null;
    let lastButtonStates = { Y: false, A: false, left: false, right: false, up: false, down: false };
    
    // Sesiones programadas inyectadas desde el backend
    const sesiones = {{ sesiones|tojson }};
    
    // Normaliza Fecha_Programada a objetos Date sin cambios de zona horaria
    sesiones.forEach(sesion => {
        if (sesion.Fecha_Programada) {
            const [fecha, hora] = sesion.Fecha_Programada.split('T');
            const [y, m, d] = fecha.split('-').map(Number);

            if (hora) {
                const [hh, mm] = hora.split(':').map(Number);
                sesion.fecha_obj = new Date(y, m - 1, d, hh, mm);
            } else {
                sesion.fecha_obj = new Date(y, m - 1, d, 0, 0);
            }
        } else {
            sesion.fecha_obj = null;
        }
    });

    // Actualiza el badge de estado del mando
    function setMandoStatus(text, klass) {
        mandoStatus.className = 'badge ' + klass;
        mandoStatus.innerHTML = `<i class="bi bi-controller me-1"></i>${text}`;
    }
    
    // Devuelve el lunes de la semana de la fecha dada
    function getMonday(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    }
    
    // Obtiene la fecha de inicio del periodo mostrado (hoy o siguiente lunes)
    function getStartDate() {
        const today = new Date();
        const currentDay = today.getDay();
        
        if (currentDay >= 1) {
            return new Date(today.getFullYear(), today.getMonth(), today.getDate());
        } else {
            const nextMonday = new Date(today);
            nextMonday.setDate(today.getDate() + 1);
            return nextMonday;
        }
    }
    
    // Construye el array de sesiones navegables (solo estados pendientes)
    function updateAvailableSessions() {
        availableSessions = [];
        document.querySelectorAll('.session-item').forEach((item) => {
            if (item.dataset.sesionId) {
                availableSessions.push({
                    element: item,
                    sesionId: item.dataset.sesionId
                });
            }
        });
        console.log(`Sesiones disponibles para navegación con mando: ${availableSessions.length}`);
    }
    
    // Marca visualmente una sesión según índice (para navegación con mando)
    function highlightSession(index) {
        document.querySelectorAll('.session-item').forEach(item => {
            item.classList.remove('mando-highlighted');
        });
        
        if (index >= 0 && index < availableSessions.length) {
            const sessionData = availableSessions[index];
            sessionData.element.classList.add('mando-highlighted');
            sessionData.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Selecciona sesión al mover el foco con mando
            selectSession(sessionData.sesionId);
        }
    }
    
    // Dibuja las 3 semanas de calendario y vincula sesiones
    function renderCalendar() {
        const startDate = getStartDate();
        const endDate = new Date(startDate);
        endDate.setDate(startDate.getDate() + 20);
        
        dateRange.textContent = `${startDate.toLocaleDateString('es-ES')} - ${endDate.toLocaleDateString('es-ES')}`;
        
        let html = '';
        let currentWeekStart = getMonday(startDate);
        
        for (let week = 0; week < 3; week++) {
            html += '<div class="row g-0">';
            
            for (let day = 0; day < 7; day++) {
                const currentDate = new Date(currentWeekStart);
                currentDate.setDate(currentWeekStart.getDate() + (week * 7) + day);
                
                const isValidDay = currentDate >= startDate;
                
                const daySessions = sesiones.filter(sesion => {
                    return sesion.fecha_obj.toDateString() === currentDate.toDateString();
                });
                
                html += `<div class="col calendar-day ${!isValidDay ? 'text-muted' : ''}" data-date="${currentDate.toISOString()}">`;
                html += `<div class="day-number">${currentDate.getDate()}</div>`;
                
                if (isValidDay) {
                    html += '<div class="day-sessions">';
                    
                    daySessions.forEach(sesion => {
                        if (sesion.Estado === 'PENDIENTE') {
                            const hora = sesion.Hora_Texto || sesion.fecha_obj.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'});
                            html += `<div class="session-item" data-sesion-id="${sesion.Id}">`;
                            html += `<div><strong>${hora}</strong></div>`;
                            html += `<div class="text-truncate">${sesion.profesional.usuario.Nombre}</div>`;
                            html += `<div class="text-truncate small">${sesion.profesional.Tipo_Profesional}</div>`;
                            html += '</div>';
                        }
                    });
                    
                    html += '</div>';
                }
                
                html += '</div>';
            }
            
            html += '</div>';
        }
        
        calendarWeeks.innerHTML = html;
        
        // Asociación de clic a cada sesión
        document.querySelectorAll('.session-item').forEach(item => {
            item.addEventListener('click', function() {
                selectSession(this.dataset.sesionId);
            });
        });
        
        // Construcción de la lista para navegación con mando
        setTimeout(() => {
            updateAvailableSessions();
            if (availableSessions.length > 0 && selectedSessionIndex === -1) {
                selectedSessionIndex = 0;
                highlightSession(selectedSessionIndex);
            }
        }, 100);
    }
    
    // Selecciona una sesión (clic o mando) y actualiza panel inferior
    function selectSession(sesionId) {
        document.querySelectorAll('.session-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        const sesion = sesiones.find(s => s.Id == sesionId);
        if (sesion && sesion.Estado === 'PENDIENTE') {
            selectedSession = sesion;
            
            const sessionElement = document.querySelector(`[data-sesion-id="${sesionId}"]`);
            if (sessionElement) {
                sessionElement.classList.add('selected');
                sessionElement.style.background = '#dc3545 !important';
            }
            
            const fecha = sesion.fecha_obj.toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const hora = sesion.Hora_Texto || sesion.fecha_obj.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'});
            
            selectedSessionInfo.innerHTML = `
                <h6 class="text-primary mb-2">${fecha} a las ${hora}</h6>
                <p class="mb-1"><strong>Profesional:</strong> ${sesion.profesional.usuario.Nombre} ${sesion.profesional.usuario.Apellidos}</p>
                <p class="mb-1"><strong>Especialidad:</strong> ${sesion.profesional.Tipo_Profesional}</p>
                <p class="mb-0"><strong>Ejercicios:</strong> ${sesion.ejercicios_sesion.length}</p>
            `;
            
            selectedSessionCard.style.display = 'block';
            startSessionBtn.style.display = 'block';
            startSessionBtn.onclick = () => {
                window.location.href = `/paciente/ejecutar_sesion/${sesionId}`;
            };
        }
    }
    
    // Gamepad API: conexión y estado visual
    window.addEventListener('gamepadconnected', (e) => {
        gamepadIndex = e.gamepad.index;
        console.log('Mando conectado (mis_sesiones):', e.gamepad.id);
        setMandoStatus('Mando Conectado', 'bg-success');
        requestAnimationFrame(pollGamepad);
    });

    window.addEventListener('gamepaddisconnected', () => {
        console.log('Mando desconectado (mis_sesiones)');
        gamepadIndex = null;
        setMandoStatus('Mando Desconectado', 'bg-danger');
    });

    // Bucle de lectura del mando para navegación en esta pantalla
    function pollGamepad() {
        if (gamepadIndex === null) return;

        const pads = navigator.getGamepads();
        const gp = pads[gamepadIndex];
        if (!gp) {
            requestAnimationFrame(pollGamepad);
            return;
        }

        // Mapping adaptado: 0=X, 1=A, 2=B, 3=Y
        const btnA = gp.buttons[1]?.pressed || false;
        const btnY = gp.buttons[3]?.pressed || false;

        const axisX = gp.axes[0] || 0;
        const axisY = gp.axes[1] || 0;

        const left  = axisX < -0.5;
        const right = axisX >  0.5;
        const up    = axisY < -0.5;
        const down  = axisY >  0.5;

        const states = { Y: btnY, A: btnA, left, right, up, down };

        // Y: volver a la pantalla principal del paciente
        if (states.Y && !lastButtonStates.Y) {
            backBtn.click();
        }
        
        // A: iniciar sesión actualmente seleccionada (si existe)
        if (states.A && !lastButtonStates.A && selectedSession) {
            startSessionBtn.classList.add('mando-selected');
            setTimeout(() => {
                startSessionBtn.click();
            }, 300);
        }
        
        // Navegación lateral entre sesiones (si hay varias)
        if (states.left && !lastButtonStates.left) {
            if (selectedSessionIndex > 0) {
                selectedSessionIndex--;
                highlightSession(selectedSessionIndex);
            }
        }
        
        if (states.right && !lastButtonStates.right) {
            if (selectedSessionIndex < availableSessions.length - 1) {
                selectedSessionIndex++;
                highlightSession(selectedSessionIndex);
            }
        }
        
        // Scroll vertical con cruceta o stick
        if (states.up && !lastButtonStates.up) {
            window.scrollBy(0, -200);
        }
        
        if (states.down && !lastButtonStates.down) {
            window.scrollBy(0, 200);
        }
        
        lastButtonStates = states;
        requestAnimationFrame(pollGamepad);
    }
    
    // Render inicial del calendario
    renderCalendar();
    
    // Configura auto-renovación del calendario cada lunes
    const now = new Date();
    const nextMonday = new Date(now);
    nextMonday.setDate(now.getDate() + (8 - now.getDay()) % 7);
    nextMonday.setHours(0, 0, 0, 0);
    
    const timeUntilNextMonday = nextMonday.getTime() - now.getTime();
    setTimeout(() => {
        renderCalendar();
        setInterval(renderCalendar, 7 * 24 * 60 * 60 * 1000);
    }, timeUntilNextMonday);
});
</script>

{% endblock %}