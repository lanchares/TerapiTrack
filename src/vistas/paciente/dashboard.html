{% extends "base.html" %}

{% block title %}Dashboard - Paciente - TerapiTrack{% endblock %}

{% block content %}
<div class="container-fluid" style="min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem 0;">
    
    <!-- âœ… BotÃ³n de logout discreto (no accesible con mando) -->
    <div class="position-absolute top-0 end-0 p-3" style="z-index: 1000;">
        <div class="dropdown">
            <button class="btn btn-outline-light btn-sm opacity-25" 
                    type="button" 
                    id="sessionMenu" 
                    data-bs-toggle="dropdown" 
                    aria-expanded="false"
                    onmouseover="this.classList.remove('opacity-25')" 
                    onmouseout="this.classList.add('opacity-25')"
                    style="border: none; background: rgba(255,255,255,0.1);">
                <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sessionMenu">
                <li>
                    <span class="dropdown-item-text">
                        <small class="text-muted">{{ current_user.Nombre }}</small>
                    </span>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <!-- âœ… Enlace directo sin JavaScript -->
                    <a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                        <i class="bi bi-box-arrow-right me-2"></i>Cerrar SesiÃ³n
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Header -->
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-white mb-3">Â¡Hola, {{ current_user.Nombre }}!</h1>
        <p class="lead text-white">Bienvenido a tu espacio de terapia</p>
        
        <!-- Estado del mando (solo visual, se actualiza desde JS) -->
        <div class="alert alert-light d-inline-block" id="gamepad-status">
            <i class="bi bi-controller me-2"></i>
            Mando SNES: 
            <span class="badge bg-secondary">Buscando...</span>
        </div>
    </div>

    <!-- Botones SNES con posiciones correctas segÃºn mando real -->
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="snes-layout">
                <!-- Fila superior: X (azul) - EJERCICIOS -->
                <div class="d-flex justify-content-center mb-4">
                    <a href="{{ url_for('paciente.ejercicios') }}" class="snes-btn snes-x" id="btn-ejercicios">
                        <div class="btn-inner">
                            <span class="btn-letter">X</span>
                            <i class="bi bi-play-circle fs-1"></i>
                            <span class="btn-label">Ejercicios</span>
                        </div>
                    </a>
                </div>
                
                <!-- Fila media: Y (verde) y A (rojo) -->
                <div class="d-flex justify-content-center align-items-center mb-4">
                    <!-- Y (verde) - izquierda - MIS SESIONES -->
                    <a href="{{ url_for('paciente.mis_sesiones') }}" class="snes-btn snes-y me-5" id="btn-sesiones">
                        <div class="btn-inner">
                            <span class="btn-letter">Y</span>
                            <i class="bi bi-calendar-check fs-1"></i>
                            <span class="btn-label">Mis Sesiones</span>
                        </div>
                    </a>
                    
                    <div style="width: 100px;"></div>
                    
                    <!-- A (rojo) - derecha - MI PROGRESO -->
                    <a href="{{ url_for('paciente.progreso') }}" class="snes-btn snes-a ms-5" id="btn-progreso">
                        <div class="btn-inner">
                            <span class="btn-letter">A</span>
                            <i class="bi bi-graph-up fs-1"></i>
                            <span class="btn-label">Mi Progreso</span>
                        </div>
                    </a>
                </div>
                
                <!-- Fila inferior: B (amarillo) - AYUDA -->
                <div class="d-flex justify-content-center">
                    <a href="{{ url_for('paciente.ayuda') }}" class="snes-btn snes-b" id="btn-ayuda">
                        <div class="btn-inner">
                            <span class="btn-letter">B</span>
                            <i class="bi bi-question-circle fs-1"></i>
                            <span class="btn-label">Ayuda</span>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- InformaciÃ³n de contacto -->
    <div class="row justify-content-center mt-5">
        <div class="col-md-6">
            <div class="card bg-white bg-opacity-90 shadow-lg">
                <div class="card-body text-center py-3">
                    <h6 class="text-primary mb-2"><i class="bi bi-telephone-fill me-2"></i>Â¿Necesitas ayuda?</h6>
                    <p class="mb-1 h5 text-success fw-bold">ðŸ“ž 666-666-666</p>
                    <small class="text-muted">LÃ­nea de soporte tÃ©cnico â€¢ 24H</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Instrucciones de navegaciÃ³n -->
    <div class="navigation-help">
        <strong>ðŸŽ® NavegaciÃ³n:</strong><br>
        â†‘ â†“ : Bajar/Subir en la pantalla<br>
        Botones : Seleccionar opciÃ³n
    </div>
</div>

<style>
.snes-layout {
    max-width: 500px;
    margin: 0 auto;
    padding: 2rem;
}

.snes-btn {
    display: block;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    text-decoration: none;
    color: white;
    font-weight: bold;
    transition: all 0.3s ease;
    border: 4px solid rgba(255,255,255,0.3);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    position: relative;
    overflow: hidden;
}

.snes-btn:hover {
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 12px 25px rgba(0,0,0,0.4);
    color: white;
    text-decoration: none;
}

.snes-btn:active {
    transform: translateY(-2px) scale(0.98);
}

.btn-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    padding: 10px;
}

.btn-letter {
    position: absolute;
    top: 8px;
    right: 12px;
    font-size: 1.2rem;
    font-weight: bold;
    opacity: 0.9;
}

.btn-label {
    font-size: 0.9rem;
    margin-top: 5px;
    font-weight: 600;
}

/* Colores correctos segÃºn posiciÃ³n del mando SNES */
.snes-x {
    background: linear-gradient(145deg, #4169E1, #1E90FF);  /* X = Azul (arriba) */
}

.snes-a {
    background: linear-gradient(145deg, #DC143C, #B22222);  /* A = Rojo (derecha) */
}

.snes-b {
    background: linear-gradient(145deg, #FFD700, #DAA520);  /* B = Amarillo (abajo) */
}

.snes-y {
    background: linear-gradient(145deg, #228B22, #006400);  /* Y = Verde (izquierda) */
}

/* Efectos activos para el mando */
.snes-btn.controller-active {
    transform: scale(0.95);
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

.snes-btn.mando-selected {
    animation: pulseGlow 0.5s ease-in-out;
}

@keyframes pulseGlow {
    0% { box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
    50% { box-shadow: 0 12px 30px rgba(255,255,255,0.5); }
    100% { box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
}

/* Instrucciones de navegaciÃ³n */
.navigation-help {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 15px;
    border-radius: 10px;
    font-size: 0.9rem;
    z-index: 1000;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}
</style>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const buttons = {
        'X': document.getElementById('btn-ejercicios'),
        'Y': document.getElementById('btn-sesiones'),
        'A': document.getElementById('btn-progreso'),
        'B': document.getElementById('btn-ayuda')
    };

    const gamepadStatus = document.getElementById('gamepad-status');
    let gamepadIndex = null;
    let lastButtonStates = { X: false, Y: false, A: false, B: false, up: false, down: false };

    function setStatus(text, klass) {
        if (!gamepadStatus) return;
        const badge = gamepadStatus.querySelector('span.badge');
        badge.textContent = text;
        badge.className = 'badge ' + klass;
    }

    window.addEventListener('gamepadconnected', (e) => {
        gamepadIndex = e.gamepad.index;
        setStatus('Conectado', 'bg-success');
        console.log('ðŸŽ® Mando conectado:', e.gamepad.id);
        requestAnimationFrame(pollGamepad);
    });

    window.addEventListener('gamepaddisconnected', () => {
        console.log('ðŸŽ® Mando desconectado');
        gamepadIndex = null;
        setStatus('Desconectado', 'bg-danger');
        // quitar efectos visuales
        Object.values(buttons).forEach(btn => btn && btn.classList.remove('controller-active'));
    });

    function navigateWithController(button) {
        const targetButton = buttons[button];
        if (!targetButton) return;

        targetButton.classList.add('mando-selected');
        setTimeout(() => targetButton.classList.remove('mando-selected'), 500);

        setTimeout(() => {
            window.location.href = targetButton.href;
        }, 300);
    }

    function pollGamepad() {
        if (gamepadIndex === null) return;

        const gamepads = navigator.getGamepads();
        const gp = gamepads[gamepadIndex];
        if (!gp) {
            requestAnimationFrame(pollGamepad);
            return;
        }

        // Mapping tÃ­pico: 0=A, 1=B, 2=X, 3=Y en mandos tipo Xbox.
        // Lo adaptamos a tus letras SNES:
        const btnA = gp.buttons[0]?.pressed || false; // A rojo
        const btnB = gp.buttons[1]?.pressed || false; // B amarillo
        const btnX = gp.buttons[2]?.pressed || false; // X azul
        const btnY = gp.buttons[3]?.pressed || false; // Y verde

        const up    = (gp.axes[1] || 0) < -0.5;
        const down  = (gp.axes[1] || 0) >  0.5;

        const states = { X: btnX, Y: btnY, A: btnA, B: btnB, up, down };

        // Efectos visuales
        Object.keys(buttons).forEach(letter => {
            const btnEl = buttons[letter];
            if (!btnEl) return;
            if (states[letter]) btnEl.classList.add('controller-active');
            else btnEl.classList.remove('controller-active');
        });

        // Scroll con â†‘ â†“ (flanco de subida)
        if (states.up && !lastButtonStates.up) {
            window.scrollBy(0, -200);
        }
        if (states.down && !lastButtonStates.down) {
            window.scrollBy(0, 200);
        }

        // NavegaciÃ³n por botones (flanco de subida)
        ['X','Y','A','B'].forEach(letter => {
            if (states[letter] && !lastButtonStates[letter]) {
                navigateWithController(letter);
            }
        });

        lastButtonStates = states;
        requestAnimationFrame(pollGamepad);
    }

    // Si el usuario conecta el mando despuÃ©s de cargar la pÃ¡gina,
    // el evento gamepadconnected dispararÃ¡ pollGamepad.
    // Si ya estaba conectado, algunos navegadores requieren una tecla/botÃ³n
    // para disparar el evento, asÃ­ que dejamos el estado como "Buscando...".
});
</script>
{% endblock %}
{% endblock %}
