{% extends "base.html" %}

{% block title %}Dashboard - Paciente - TerapiTrack{% endblock %}

{% block content %}
<div class="container-fluid" style="min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem 0;">
    
    <!-- Bot√≥n de logout discreto (pensado para rat√≥n/t√°ctil, no para el mando) -->
    <div class="position-absolute top-0 end-0 p-3" style="z-index: 1000;">
        <div class="dropdown">
            <button class="btn btn-outline-light btn-sm opacity-25" 
                    type="button" 
                    id="sessionMenu" 
                    data-bs-toggle="dropdown" 
                    aria-expanded="false"
                    onmouseover="this.classList.remove('opacity-25')" 
                    onmouseout="this.classList.add('opacity-25')"
                    style="border: none; background: rgba(255,255,255,0.1);">
                <i class="bi bi-three-dots"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sessionMenu">
                <li>
                    <span class="dropdown-item-text">
                        <small class="text-muted">{{ current_user.Nombre }}</small>
                    </span>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <!-- Enlace directo a logout (sin JS extra para ser robusto) -->
                    <a class="dropdown-item" href="{{ url_for('auth.logout') }}">
                        <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesi√≥n
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Cabecera de bienvenida y estado del mando -->
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold text-white mb-3">¬°Hola, {{ current_user.Nombre }}!</h1>
        <p class="lead text-white">Bienvenido a tu espacio de terapia</p>
        
        <!-- Indicador del estado del mando SNES, solo informativo -->
        <div class="alert alert-light d-inline-block" id="gamepad-status">
            <i class="bi bi-controller me-2"></i>
            Mando SNES: 
            <span class="badge bg-secondary">Buscando...</span>
        </div>
    </div>

    <!-- Distribuci√≥n de botones imitando el mando SNES -->
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="snes-layout">
                <!-- X (arriba, azul): acceso a ejercicios -->
                <div class="d-flex justify-content-center mb-4">
                    <a href="{{ url_for('paciente.ejercicios') }}" class="snes-btn snes-x" id="btn-ejercicios">
                        <div class="btn-inner">
                            <span class="btn-letter">X</span>
                            <i class="bi bi-play-circle fs-1"></i>
                            <span class="btn-label">Ejercicios</span>
                        </div>
                    </a>
                </div>
                
                <!-- Fila central: Y (izquierda, verde) y A (derecha, rojo) -->
                <div class="d-flex justify-content-center align-items-center mb-4">
                    <!-- Y: listado de sesiones del paciente -->
                    <a href="{{ url_for('paciente.mis_sesiones') }}" class="snes-btn snes-y me-5" id="btn-sesiones">
                        <div class="btn-inner">
                            <span class="btn-letter">Y</span>
                            <i class="bi bi-calendar-check fs-1"></i>
                            <span class="btn-label">Mis Sesiones</span>
                        </div>
                    </a>
                    
                    <div style="width: 100px;"></div>
                    
                    <!-- A: vista de progreso del paciente -->
                    <a href="{{ url_for('paciente.progreso') }}" class="snes-btn snes-a ms-5" id="btn-progreso">
                        <div class="btn-inner">
                            <span class="btn-letter">A</span>
                            <i class="bi bi-graph-up fs-1"></i>
                            <span class="btn-label">Mi Progreso</span>
                        </div>
                    </a>
                </div>
                
                <!-- B (abajo, amarillo): secci√≥n de ayuda -->
                <div class="d-flex justify-content-center">
                    <a href="{{ url_for('paciente.ayuda') }}" class="snes-btn snes-b" id="btn-ayuda">
                        <div class="btn-inner">
                            <span class="btn-letter">B</span>
                            <i class="bi bi-question-circle fs-1"></i>
                            <span class="btn-label">Ayuda</span>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjeta con datos de contacto de soporte -->
    <div class="row justify-content-center mt-5">
        <div class="col-md-6">
            <div class="card bg-white bg-opacity-90 shadow-lg">
                <div class="card-body text-center py-3">
                    <h6 class="text-primary mb-2"><i class="bi bi-telephone-fill me-2"></i>¬øNecesitas ayuda?</h6>
                    <p class="mb-1 h5 text-success fw-bold">üìû 666-666-666</p>
                    <small class="text-muted">L√≠nea de soporte t√©cnico ‚Ä¢ 24H</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Leyenda fija con instrucciones de uso del mando -->
    <div class="navigation-help">
        <strong>üéÆ Navegaci√≥n:</strong><br>
        ‚Üë ‚Üì : Bajar/Subir en la pantalla<br>
        Botones : Seleccionar opci√≥n
    </div>
</div>

<style>
/* Contenedor general del layout SNES */
.snes-layout {
    max-width: 500px;
    margin: 0 auto;
    padding: 2rem;
}

/* Estilo base de los botones circulares SNES */
.snes-btn {
    display: block;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    text-decoration: none;
    color: white;
    font-weight: bold;
    transition: all 0.3s ease;
    border: 4px solid rgba(255,255,255,0.3);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    position: relative;
    overflow: hidden;
}

.snes-btn:hover {
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 12px 25px rgba(0,0,0,0.4);
    color: white;
    text-decoration: none;
}

.snes-btn:active {
    transform: translateY(-2px) scale(0.98);
}

/* Contenido interno de cada bot√≥n (icono + texto) */
.btn-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    text-align: center;
    padding: 10px;
}

/* Letra de bot√≥n (X, Y, A, B) en la esquina superior */
.btn-letter {
    position: absolute;
    top: 8px;
    right: 12px;
    font-size: 1.2rem;
    font-weight: bold;
    opacity: 0.9;
}

/* Etiqueta inferior con el nombre de la secci√≥n */
.btn-label {
    font-size: 0.9rem;
    margin-top: 5px;
    font-weight: 600;
}

/* Colores seg√∫n posici√≥n del mando SNES real */
.snes-x {
    background: linear-gradient(145deg, #4169E1, #1E90FF);  /* X = Azul (arriba) */
}

.snes-a {
    background: linear-gradient(145deg, #DC143C, #B22222);  /* A = Rojo (derecha) */
}

.snes-b {
    background: linear-gradient(145deg, #FFD700, #DAA520);  /* B = Amarillo (abajo) */
}

.snes-y {
    background: linear-gradient(145deg, #228B22, #006400);  /* Y = Verde (izquierda) */
}

/* Efecto visual cuando se pulsa desde el mando */
.snes-btn.controller-active {
    transform: scale(0.95);
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}

/* Peque√±a animaci√≥n cuando se selecciona una opci√≥n con el mando */
.snes-btn.mando-selected {
    animation: pulseGlow 0.5s ease-in-out;
}

@keyframes pulseGlow {
    0% { box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
    50% { box-shadow: 0 12px 30px rgba(255,255,255,0.5); }
    100% { box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
}

/* Caja flotante con ayuda de navegaci√≥n */
.navigation-help {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 15px;
    border-radius: 10px;
    font-size: 0.9rem;
    z-index: 1000;
    box-shadow: 0 4px 15px rgba(0,0,0,0.5);
}
</style>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Mapeo visual de letras SNES a cada bot√≥n de la interfaz
    const buttons = {
        'X': document.getElementById('btn-ejercicios'),
        'Y': document.getElementById('btn-sesiones'),
        'A': document.getElementById('btn-progreso'),
        'B': document.getElementById('btn-ayuda')
    };

    const gamepadStatus = document.getElementById('gamepad-status');
    let gamepadIndex = null;
    // √öltimo estado conocido de los botones/ejes, para detectar flancos
    let lastButtonStates = { X: false, Y: false, A: false, B: false, up: false, down: false };

    // Actualiza el badge de estado del mando
    function setStatus(text, klass) {
        if (!gamepadStatus) return;
        const badge = gamepadStatus.querySelector('span.badge');
        badge.textContent = text;
        badge.className = 'badge ' + klass;
    }

    // Evento cuando se conecta un gamepad compatible
    window.addEventListener('gamepadconnected', (e) => {
        gamepadIndex = e.gamepad.index;
        setStatus('Conectado', 'bg-success');
        console.log('üéÆ Mando conectado:', e.gamepad.id);
        requestAnimationFrame(pollGamepad);
    });

    // Evento cuando se desconecta el gamepad
    window.addEventListener('gamepaddisconnected', () => {
        console.log('üéÆ Mando desconectado');
        gamepadIndex = null;
        setStatus('Desconectado', 'bg-danger');
        // Limpia efectos activos sobre los botones
        Object.values(buttons).forEach(btn => btn && btn.classList.remove('controller-active'));
    });

    // Navegaci√≥n a una ruta usando el mando (a√±ade animaci√≥n y luego redirige)
    function navigateWithController(button) {
        const targetButton = buttons[button];
        if (!targetButton) return;

        targetButton.classList.add('mando-selected');
        setTimeout(() => targetButton.classList.remove('mando-selected'), 500);

        setTimeout(() => {
            window.location.href = targetButton.href;
        }, 300);
    }

    // Bucle de lectura de estado del mando (Gamepad API)
    function pollGamepad() {
        if (gamepadIndex === null) return;

        const gamepads = navigator.getGamepads();
        const gp = gamepads[gamepadIndex];
        if (!gp) {
            requestAnimationFrame(pollGamepad);
            return;
        }

        // Mapping adaptado: 0=X, 1=A, 2=B, 3=Y
        const btnX = gp.buttons[0]?.pressed || false; // A rojo (bottom)
        const btnA = gp.buttons[1]?.pressed || false; // B amarillo (right)
        const btnB = gp.buttons[2]?.pressed || false; // X azul (left)
        const btnY = gp.buttons[3]?.pressed || false; // Y verde (top)

        const up    = (gp.axes[1] || 0) < -0.5;
        const down  = (gp.axes[1] || 0) >  0.5;

        const states = { X: btnX, Y: btnY, A: btnA, B: btnB, up, down };

        // Marca visualmente los botones que se est√°n pulsando
        Object.keys(buttons).forEach(letter => {
            const btnEl = buttons[letter];
            if (!btnEl) return;
            if (states[letter]) btnEl.classList.add('controller-active');
            else btnEl.classList.remove('controller-active');
        });

        // Scroll vertical con la cruceta (solo en flanco de subida)
        if (states.up && !lastButtonStates.up) {
            window.scrollBy(0, -200);
        }
        if (states.down && !lastButtonStates.down) {
            window.scrollBy(0, 200);
        }

        // Acciones asociadas a cada bot√≥n SNES (solo flanco de subida)
        ['X','Y','A','B'].forEach(letter => {
            if (states[letter] && !lastButtonStates[letter]) {
                navigateWithController(letter);
            }
        });

        lastButtonStates = states;
        requestAnimationFrame(pollGamepad);
    }

    // Nota: si el mando ya estaba conectado antes de cargar la p√°gina,
    // algunos navegadores requieren pulsar un bot√≥n para disparar gamepadconnected.
});
</script>
{% endblock %}
{% endblock %}
